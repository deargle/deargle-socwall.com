var Tip=Class.extend({initialize:function(target,options){this.options=$.extend(true,{'ajax':false,'showOn':'click','hideOn':'','destroyOnHide':false,'content':false,'class':'','targetCorner':'bottomCenter','tipCorner':'topLeft','offset':{'top':0,'left':0},'triangle':true},options||{});this.target=$(target);this.target.addClass('tipTarget');this.window=$(window);this.body=$('body');this.create();},create:function(){this.tipWrapper=$('<div style="display: none;" />');this.tipWrapper.addClass('tipWrapper');this.tip=$('<div />');this.tip.addClass('tip');this.tip.addClass(this.options['class']);this.tip.appendTo(this.tipWrapper);if(this.options.ajax==false){this.setContent(this.options.content);}
if(this.options.triangle){this.triangle=$('<div />');this.triangle.addClass('triangle');this.triangle.appendTo(this.tip);}
this.tipWrapper.appendTo($('body'));if(this.options.ajax!==false){this.loadAjaxContent();}
this.addEventListeners();},addEventListeners:function(){var self=this;if(this.options.showOn=='hover'){this.target.hover(function(event){self.show();},function(event){self.hide();});}
else if(this.options.showOn=='click'){this.target.bind('click',function(event){self.show();});}},loadAjaxContent:function(){this.setContent('<div class="tipLoader">Loading...</div>');var self=this;this.options.ajax.success=function(data){self.tipWrapper.css('visibility','hidden');self.setContent(data);self.updatePosition();self.tipWrapper.css('visibility','visible');if(self.options.ajax.onSuccess&&typeof(self.options.ajax.onSuccess)=='function'){self.options.ajax.onSuccess();}}
this.ajax=$.ajax(this.options.ajax);},show:function(){var self=this;this.updatePosition();this.tipWrapper.show();this.window.resize(function(event){self.updatePosition();});if(this.target.offsetParent().css('position')=='fixed'){this.window.bind('scroll.fixedTip',function(event){self.updatePosition();});}
var windowHeight=this.window.height();var windowScrollTop=this.window.scrollTop();var targetPosition=this.target.position();var tipWrapperTop=targetPosition.top;var tipWrapperHeight=this.tipWrapper.outerHeight();var tipBottom=tipWrapperTop+tipWrapperHeight+24;var windowBottom=windowScrollTop+windowHeight;if(windowBottom<tipBottom&&tipWrapperTop<windowBottom&&tipWrapperTop>0){$.scrollTo(tipBottom-windowHeight+'px',250,{axis:'y'});}
this.tipWrapper.bind('mouseenter.closeTip',function(){self.mouseIsInside=true;});this.tipWrapper.bind('mouseleave.closeTip',function(){self.mouseIsInside=false;});this.body.bind('mouseup.closeTip',function(event){if(!self.mouseIsInside&&$(event.target).closest(this.target).length===0){self.hide();}});},hide:function(speed,options){if(this.target.offsetParent().css('position')=='fixed'){this.window.unbind('scroll.fixedTip');}
this.body.unbind('.closeTip');this.tipWrapper.unbind('.closeTip');if(options!=undefined&&options.onAfter!=undefined){this.tipWrapper.hide(0,function(){options.onAfter();});}
else{this.tipWrapper.hide(0);}
if(this.options.destroyOnHide===true){this.destroy();}},destroy:function(){this.tipWrapper.remove();},setContent:function(content){if(content.show){content.show();}
this.tip.empty().append(content);},updatePosition:function(){var targetPosition=this.target.position();var targetHeight=this.target.outerHeight(true);var targetWidth=this.target.outerWidth();var tipWrapperTop=targetPosition.top+parseInt(this.options.offset.top,10);var tipWrapperLeft=targetPosition.left+parseInt(this.options.offset.left,10);var tipWrapperHeight=this.tipWrapper.outerHeight();var tipWrapperWidth=this.tipWrapper.outerWidth();var windowHeight=$(window).height();var windowWidth=$(window).width();var windowScrollTop=$(window).scrollTop();if(this.target.offsetParent().css('position')=='fixed'){tipWrapperTop=tipWrapperTop+windowScrollTop;}
switch(this.options.targetCorner){case 'bottomCenter':tipWrapperTop=tipWrapperTop+targetHeight;tipWrapperLeft=tipWrapperLeft+(targetWidth/2);break;case 'topCenter':tipWrapperLeft=tipWrapperLeft-(targetWidth/2);break;case 'bottomLeft':tipWrapperTop=tipWrapperTop+targetHeight;break;case 'rightCenter':tipWrapperTop=tipWrapperTop+(targetHeight/2);tipWrapperLeft=tipWrapperLeft+targetWidth;break;default:break;}
switch(this.options.tipCorner){case 'topLeft':break;case 'leftTop':break;case 'topRight':tipWrapperLeft=tipWrapperLeft-tipWrapperWidth;break;case 'bottomCenter':tipWrapperTop=tipWrapperTop-tipWrapperHeight;tipWrapperLeft=tipWrapperLeft-(tipWrapperWidth/2);break;case 'leftCenter':tipWrapperTop=tipWrapperTop-(tipWrapperHeight/2);break;default:break;}
if((tipWrapperWidth+tipWrapperLeft)>windowWidth){tipWrapperLeft=tipWrapperLeft+(windowWidth-(tipWrapperWidth+tipWrapperLeft))-12;}
else if(tipWrapperLeft<12){tipWrapperLeft=12;}
this.tipWrapper.css({'top':tipWrapperTop,'left':tipWrapperLeft});},setTarget:function(target){var self=this;this.target=$(target);if(this.tipWrapper.is(':visible')){this.hide(0,{onAfter:function(){self.show(250);}});}
else{this.show();}}});